<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.4.2.min.js"><\/script>');</script>
        <script>
            /* KoalaJS 0.1a */
            (function($){
                $.koala = {
                    isset: function(val){
                        return typeof val !== "undefined" && val;
                    },
                    __sourceList : {},
                    __modelList:{},
                    define : {
                        model: function(modelName,options){
                            $.koala.__modelList[modelName] = options;
                        },
                        source: function(sourceName,options){
                            $.koala.__sourceList[sourceName] = options;
                        }
                    },
                    source: function(sourceName){
                        this.sourceName = sourceName;
                        this.load = function(options){
                            var me 		= this,
                            srcCfg 	= $.koala.__sourceList[sourceName];
                            srcCfg.model;
                            if ($.koala.isset(srcCfg.url)) {
                                if ($.koala.isset(srcCfg.model)) {
                                    if($.koala.isset(srcCfg.reader)){
                                        switch(srcCfg.reader.type){
                                            case 'json' :
                                                $.getJSON(srcCfg.url,function(json){
                                                    var results = $.koala.__parseJSON(json,srcCfg.reader.root,srcCfg.model);
                                                    options.callback(results)
                                                })
                                                break;
                                            case 'jsonp' :
                                                break;
                                        }
                                    }
                                } else {
                                    throw new Exception("No Definido Modelo del source");
                                }
                            } else {
                                throw new Exception("No Definida url del Proxy");
                            }
                        };
                        this.on = function(){
                            return this;
                        };
                        return this;
                    },
                    __parseJSON : function(json,root,model){
                        var jsonResult = eval("json."+root),
                        tmp = {};
                        return $.map(jsonResult,function(o){
                            tmp = {};
                            $.map($.koala.__modelList[model].fields,function(field){
                                tmp[field.name] = o[field.name];
                                return tmp;
                            });
                            return tmp;
                        });
                    }
                };
                $.fn.getRecord = function(callback) {
                     return $(this).each(function(){
                        callback($(this).data("koalaRecord"));
                     });
                };
                $.fn.loadRecord = function(record) {
                    return $(this).each(function(){
                        $(this).data("koalaRecord",record);
                        for (var fieldName in record) {
                            $('input[name="'+fieldName+'"]',$(this)).val(record[fieldName]);
                        }
                    });
                };
            })( jQuery );
            
            
            
            
            
            
            /*
             *  Test KoalaJS
             *
             */
            
            $(function() {
                /*
                 * Definici贸n de Modelo , estructura de la informaci贸n
                 */
                $.koala.define.model('Test',{
                    primary: ['id_usuario'],
                    fields:[
                        { name: 'id_usuario',	type: 'string' },
                        { name: 'firstname',	type: 'string', defaultValue:'Esteban' },
                        { name: 'lastname',	type: 'string', defaultValue:'Fuentealba' }
                    ]
                });
                
                /*
                 * definici贸n de la fuente de datos, se asigna un modelo a parsear
                 */
                $.koala.define.source('Test',{
                    model: 'Test',
                    autoLoad: true,
                    autoSync: true,
                    pageSize: 10,
                    url: '/api.php',
                    reader: {
                        type: 'json',
                        root: 'items',
                        totalProperty: 'totalCount',
                        successProperty: 'success'
                    }
                });
		
                /*
                 * Definici贸n de los binds a escuchar
                 */
                $.koala.source('Test').on({
                    'load': function(records){
                        //console.log(records);
                    }
                });
                /*
                 * Metodo load del source que carga los datos y parsea el resultado a objetos segun el modelo definido
                 */
                $.koala.source('Test',[1]).load({
                    callback: function(records) {
                        /*
                         * Metodo que carga un record al formulario
                         */
                        $("#signupForm").loadRecord(records[0]);
                        /*
                         * Obtiene el record asignado
                         */
                        $("#signupForm").getRecord(function(record){
                            console.log(record);
                        })
                    }
                });
		
		
            });
        </script>
    </head>
    <body>
        <form class="cmxform" id="signupForm" method="POST" action="">
            <fieldset>
                <legend>FORM Ejemplo</legend>
                <p>
                    <label for="firstname">Nombre</label>
                    <input id="firstname" type="text" class="next_lastname_ test" name="firstname" />
                </p>
                <p>
                    <label for="lastname">Apellido</label>
                    <input id="lastname" type="text" class="test" name="lastname" />
                </p>
            </fieldset>
        </form>
    </body>
</html>