<html>
    <head>
        <script src="js/jquery.min.js"></script>
        <script>
            /* KoalaJS 0.1a */
            (function($){
                $.koala = {
                    require: function(requires,callback) {
                        var total = requires.length,
                            index = 0;
                        $.map(requires,function(require){
                            $.getScript(require).done(function(script, textStatus) {
                                index++;
                                if(total==index) { callback($); }
                            });
                        })
                    },
                    rest: {
                        "get": function(url,params,callback){
                            return $.ajax({ type: 'GET',url: url, data: params, success: callback, dataType: "json", contentType: "application/json; charset=utf-8" });
                       },
                        "post": function(url,params,callback){
                            return $.ajax({ type: 'POST',url: url, data: params, success: callback, dataType: "json", contentType: "application/json; charset=utf-8" });
                        },
                        "put": function(url,params,callback){
                            return $.ajax({ type: 'PUT', url: url, data: params, success: callback, dataType: "json", contentType: "application/json; charset=utf-8" });
                        },
                        "delete": function(options){
                            return $.ajax({ type: 'DELETE',url: url, data: params, success: callback, dataType: "json", contentType: "application/json; charset=utf-8" });
                        }
                    },
                    isset: function(val){
                        return typeof val !== "undefined" && val;
                    },
                    __sourceList : {},
                    __modelList:{},
                    define : {
                        model: function(modelName,options){
                            $.koala.__modelList[modelName] = options;
                        },
                        source: function(sourceName,options){
                            $.koala.__sourceList[sourceName] = options;
                        }
                    },
                    source: function(sourceName){
                        this.sourceName = sourceName;
                        this.load = function(options){
                            var me 	= this,
                                srcCfg 	= $.koala.__sourceList[sourceName];
                            if ($.koala.isset(srcCfg.url)) {
                                if ($.koala.isset(srcCfg.model)) {
                                    if($.koala.isset(srcCfg.reader)){
                                        switch(srcCfg.reader.type){
                                            case 'json' :
                                                $.getJSON(srcCfg.url,function(json){
                                                    var results = $.koala.__parseJSON(json,srcCfg.reader.root,srcCfg.model,sourceName);
                                                    options.callback(results)
                                                })
                                                break;
                                            case 'jsonp' :
                                                break;
                                        }
                                    }
                                } else {
                                    throw new Exception("No Definido Modelo del source");
                                }
                            } else {
                                throw new Exception("No Definida url del Proxy");
                            }
                        };
                        this.on = function(){
                              return this;
                        };
                        return this;
                    },
                    __parseJSON : function(json,root,model,source){
                        var jsonResult = eval("json."+root),
                            tmp = {};
                        return $.map(jsonResult,function(o){
                            tmp = { };
                            tmp.__koala = {
                                '__modelName' : model,
                                '__sourceName': source
                            };
                            $.map($.koala.__modelList[model].fields,function(field){
                                tmp[field.name] = o[field.name];
                                return tmp;
                            });
                            return tmp;
                        });
                    },
                    __serializeArrayToObject: function(serializeArray) {
                        var tmp = {};
                        $.map(serializeArray,function(o){
                            tmp[o.name] = o.value;
                        });
                        return tmp;
                    },
                    __getModel: function(modelName) {
                        return $.koala.__modelList[modelName];
                    },
                    __getSource: function(sourceName) {
                        return $.koala.__sourceList[sourceName];
                    },
                    __existsPrimary: function(record,values) {
                        if($.koala.isset(record)){
                            var model = $.koala.__getModel(record["__koala"]["__modelName"]); 
                            return $.koala.isset( values[model["primary"]] );
                        }
                        return false;
                    },
                    __isChanged : function(record,values,field){
                        var isChanged = false,
                            modelName;
                        if($.koala.isset(field)) {
                            return (record[field] != values[field]);
                        } else {
                            modelName = record["__koala"]["__modelName"];
                            $.map($.koala.__getModel(modelName).fields,function(field){
                                if(record[field.name].toString() != values[field.name].toString()){
                                    isChanged = true;
                                }
                            });
                            return isChanged;
                        }
                        return false;
                    }
                };
                $.fn.setSource = function(sourceName,options){
                    return $(this).each(function() {
                        var me = this;
                    });
                };
                $.fn.getRecord = function(callback) {
                     return $(this).each(function(){
                         var me = this,
                            record = $(me).data("koalaRecord");
                            callback( ($.koala.isset(record) ) ? record : null );
                     });
                };
                $.fn.loadRecord = function(record) {
                    return $(this).each(function(){
                        var me          = this,
                            modelName   = record["__koala"]["__modelName"],
                            model       = $.koala.__getModel(modelName);
                        
                        if($.koala.isset(record["__koala"]) && $.koala.isset(modelName)) {
                            var __primary = model["primary"];
                            if($("input[name='"+__primary+"']",$(me)).length == 0){
                                $(me).append($("<input type='hidden' name='"+__primary+"' />"))
                            }
                        }
                        $(me).bind("submit", function() {
                            var me              = this,
                                record          = $(me).data("koalaRecord"),
                                source          = $.koala.__getSource(record["__koala"]["__sourceName"]),
                                tmpValues       = $.koala.__serializeArrayToObject($(me).serializeArray()) ,
                                existPrimary    = $.koala.__existsPrimary(record ,tmpValues);
                            if(existPrimary){
                                if($.koala.__isChanged(record,tmpValues)){
                                    $.koala.rest.put(source.url,$.toJSON(tmpValues),function(json){
                                        console.log("success");
                                    }).success(function() { 
                                        console.log("second success"); 
                                    })
                                    .error(function() { 
                                        console.log("error"); 
                                    })
                                    .complete(function() { 
                                        console.log("complete"); 
                                    });
                                    console.log("UPDATE");
                                }
                            }
                            return false;
                        }).bind("reset", function() {
                            $.removeData(me,"koalaRecord");
                        }).data("koalaRecord",record);
                        for (var fieldName in record) {
                            $('input[name="'+fieldName+'"]',$(this)).val(record[fieldName]);
                        }
                    });
                };
            })(jQuery);
            
            
            
            
            
            
            /*
             *  Test KoalaJS
             *
             */
            
            $.koala.require([
                "js/jquery.json-2.3.min.js"
            ],function($){
                 $(function() {
                    /*
                     * Definición de Modelo , estructura de la información
                     */
                    $.koala.define.model('Test',{
                        primary: 'id_usuario',
                        fields:[
                            { name: 'id_usuario',	type: 'string' },
                            { name: 'firstname',	type: 'string', defaultValue:'Esteban' },
                            { name: 'lastname',	type: 'string', defaultValue:'Fuentealba' }
                        ]
                    });

                    /*
                     * definición de la fuente de datos, se asigna un modelo a parsear
                     */
                    $.koala.define.source('Test',{
                        model: 'Test',
                        autoLoad: true,
                        autoSync: true,
                        pageSize: 10,
                        url: '/api.php',
                        reader: {
                            type: 'json',
                            root: 'items',
                            totalProperty: 'totalCount',
                            successProperty: 'success'
                        }
                    });

                    /*
                     * Definición de los binds a escuchar
                     */
                    $.koala.source('Test').on({
                        'load': function(records){
                            //console.log(records);
                        }
                    });
                    /*
                     * Metodo load del source que carga los datos y parsea el resultado a objetos segun el modelo definido
                     */
                    $.koala.source('Test',[1]).load({
                        callback: function(records) {
                            /*
                             * Metodo que carga un record al formulario
                             */
                            $("#signupForm").loadRecord(records[0]);
                            /*
                             * Obtiene el record asignado
                             */
                            $("#signupForm").getRecord(function(record){
                                console.log(record);
                            });
                        }
                    });

                    $("#btn-load").click(function(){
                        $.koala.source('Test',[1]).load({
                            callback: function(records) {
                                $("#signupForm").loadRecord(records[0]);
                            }
                        });
                    });
                    $("#btn-get").click(function(){
                        $("#signupForm").getRecord(function(record){
                            if(record){
                                $("body").append("Nombre: "+record.firstname+"<br />");
                            }
                        });
                    });

                    $("#btn-create").click(function(){
                        $("#signupForm").getRecord(function(record){
                            //console.log(record);
                            //console.log($("#signupForm").serialize());
                        });
                    })

                });
            
            })
           
        </script>
        <style>
	label {
		display: inline-block;
		width: 5em;
	}
	</style>
    </head>
    <body>
        <form class="cmxform" id="signupForm" method="POST">
            <fieldset>
                <legend>FORM Ejemplo</legend>
                <p>
                    <label for="firstname">Nombre</label>
                    <input id="firstname" type="text" class="next_lastname_ test" name="firstname" />
                </p>
                <p>
                    <label for="lastname">Apellido</label>
                    <input id="lastname" type="text" class="test" name="lastname" />
                </p>
            </fieldset>
            <input type="reset" value="Reset" />
            <input id="btn-load" type="button" value="Load" />
            <input id="btn-get" type="button" value="Get" />
            <input id="btn-create" type="submit" value="Crear" />
        </form>
        <div class="demo">
            <p>
                <a href="#" title="That's what this widget is">Tooltips</a>
            </p>
        </div>
    </body>
</html>